<div class="salaires-container">
  <div class="header">
    <h1 class="title">{{ 'SALAIRES.TITLE' | translate }}</h1>
  </div>

  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>{{ 'MESSAGES.LOADING' | translate }}</p>
  </div>

  <div *ngIf="!loading && selectedBoat" class="content">
    <div class="tabs">
      <button class="tab-button" [class.active]="activeTab === 'ouvertes'" (click)="selectTab('ouvertes')">
        {{ 'SALAIRES.TABS.OPEN_TRIPS' | translate }}
        <span class="badge">{{ sortiesOuvertes.length }}</span>
      </button>
      <button class="tab-button" [class.active]="activeTab === 'historique'" (click)="selectTab('historique')">
        {{ 'SALAIRES.TABS.HISTORY' | translate }}
        <span class="badge">{{ sortiesCalculees.length }}</span>
      </button>
    </div>

    <div *ngIf="dernierCalcul" class="results-container">
      <div class="results-header">
        <h2>{{ 'SALAIRES.RESULTS.TITLE' | translate }} : {{ dernierCalcul.sortiesDestinations.join(', ') }}</h2>
        <button class="btn-close-results" (click)="dernierCalcul = null" [title]="'SALAIRES.RESULTS.CLOSE' | translate">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>

      <div class="accordion">
        <div class="accordion-item">
          <button class="accordion-header" (click)="toggleAccordion('summary')">
            <span>{{ 'SALAIRES.RESULTS.FINANCIAL_SUMMARY' | translate }}</span>
            <svg class="chevron" [class.rotate]="accordionState['summary']" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
          </button>
          <div class="accordion-content" [class.open]="accordionState['summary']">
            <div class="summary-grid">
              <div class="summary-item">
                <span>{{ 'SALAIRES.REVENU_TOTAL' | translate }}</span>
                <strong class="revenue">
                  {{ dernierCalcul.revenuTotal | number:'1.2-2' }} DT
                  <button (click)="showRevenueDetails()" class="details-link">({{ 'COMMON.VIEW_DETAILS' | translate }})</button>
                </strong>
              </div>
              <div class="summary-item">
                <span>{{ 'SALAIRES.TOTAL_DEPENSES' | translate }}</span>
                <strong class="expenses">
                  {{ dernierCalcul.totalDepenses | number:'1.2-2' }} DT
                  <button (click)="showExpenseDetails()" class="details-link">({{ 'COMMON.VIEW_DETAILS' | translate }})</button>
                </strong>
              </div>
              <div class="summary-item"><span>{{ 'SALAIRES.BENEFICE_NET' | translate }}</span><strong class="benefit">{{ dernierCalcul.beneficeNet | number:'1.2-2' }} DT</strong></div>
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <button class="accordion-header" (click)="toggleAccordion('sharing')">
            <span>{{ 'SALAIRES.RESULTS.PROFIT_SHARING' | translate }}</span>
            <svg class="chevron" [class.rotate]="accordionState['sharing']" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
          </button>
          <div class="accordion-content" [class.open]="accordionState['sharing']">
             <div class="summary-grid">
              <div class="summary-item"><span>{{ 'SALAIRES.PART_PROPRIETAIRE' | translate }}</span><strong>{{ dernierCalcul.partProprietaire | number:'1.2-2' }} DT</strong></div>
              <div class="summary-item"><span>{{ 'SALAIRES.PART_EQUIPAGE' | translate }}</span><strong>{{ dernierCalcul.partEquipage | number:'1.2-2' }} DT</strong></div>
              <div class="summary-item"><span>- DÃ©ductions</span><strong class="expenses">{{ dernierCalcul.deductionNuits | number:'1.2-2' }} DT</strong></div>
              <div class="summary-item net-share"><span>{{ 'SALAIRES.MONTANT_A_PARTAGER' | translate }}</span><strong>{{ dernierCalcul.montantAPartager | number:'1.2-2' }} DT</strong></div>
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <button class="accordion-header" (click)="toggleAccordion('details')">
            <span>{{ 'SALAIRES.DETAILS_PAR_MARIN' | translate }}</span>
            <svg class="chevron" [class.rotate]="accordionState['details']" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
          </button>
          <div class="accordion-content" [class.open]="accordionState['details']">
            <div class="table-container">
              <table class="salaires-table">
                <thead>
                  <tr>
                    <th>{{ 'SAILORS.TITLE' | translate }}</th>
                    <th>{{ 'SAILORS.PART' | translate }}</th>
                    <th>{{ 'SALAIRES.SALAIRE_BASE' | translate }}</th>
                    <th>{{ 'SALAIRES.PRIME_NUITS' | translate }}</th>
                    <th>{{ 'AVANCES.TITLE' | translate }}</th>
                    <th>{{ 'SALAIRES.DEJA_PAYE' | translate }}</th>
                    <th class="reste">{{ 'SALAIRES.RESTE_A_PAYER' | translate }}</th>
                    <th>{{ 'BOATS.ACTIONS' | translate }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let detail of dernierCalcul.detailsMarins">
                    <td class="marin-name">{{ detail.marinNom }}</td>
                    <td>{{ detail.part }}</td>
                    <td>{{ detail.salaireBrut | number:'1.2-2' }} DT</td>
                    <td>{{ detail.primeNuits | number:'1.2-2' }} DT</td>
                    <td class="avances">{{ detail.totalAvances | number:'1.2-2' }} DT</td>
                    <td class="paiements">{{ detail.totalPaiements | number:'1.2-2' }} DT</td>
                    <td class="reste"><strong>{{ detail.resteAPayer | number:'1.2-2' }} DT</strong></td>
                    <td>
                      <button class="btn btn-sm btn-pay" (click)="enregistrerPaiement(detail)" [disabled]="detail.resteAPayer <= 0.01">
                        {{ detail.resteAPayer > 0.01 ? ('SALAIRES.PAYER' | translate) : ('SALAIRES.PAYE' | translate) }}
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div *ngIf="!dernierCalcul">
      <div *ngIf="activeTab === 'ouvertes'" class="tab-content">
        <div class="section-card">
          <h2>{{ 'SORTIES.SELECTSORTIES' | translate }}</h2>
          <div *ngIf="sortiesOuvertes.length > 0; else noOpenTrips" class="sorties-list">
            <div *ngFor="let sortie of sortiesOuvertes" 
                 class="sortie-item" [class.selected]="isSortieSelected(sortie.id!)" (click)="toggleSortie(sortie.id!)">
              <input type="checkbox" disabled [checked]="isSortieSelected(sortie.id!)" (click)="$event.stopPropagation()">
              <div class="sortie-info">
                <strong>{{ sortie.destination }}</strong>
                <span>{{ formatDate(sortie.dateDepart) }} - {{ formatDate(sortie.dateRetour) }}</span>
              </div>
            </div>
          </div>
          <ng-template #noOpenTrips><div class="no-data-small"><p>{{ 'SALAIRES.NO_OPEN_TRIPS' | translate }}</p></div></ng-template>
          
          <button class="btn btn-success btn-lg" (click)="calculerSalaires()" [disabled]="selectedSortiesIds.length === 0 || marins.length === 0">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            {{ 'SALAIRES.CALCULER' | translate }}
          </button>
        </div>
      </div>

      <div *ngIf="activeTab === 'historique'" class="tab-content">
        <div class="section-card">
          <h2>{{ 'SALAIRES.TABS.CALCULATED_TRIPS' | translate }}</h2>
          <div *ngIf="sortiesCalculees.length > 0; else noCalculatedTrips" class="sorties-list-history">
            <div *ngFor="let sortie of sortiesCalculees" class="sortie-item-history">
              <div class="sortie-info">
                <strong>{{ sortie.destination }}</strong>
                <span>{{ formatDate(sortie.dateDepart) }} - {{ formatDate(sortie.dateRetour) }}</span>
              </div>
              <button class="btn btn-secondary btn-sm" (click)="viewCalculDetails(sortie)">{{ 'COMMON.VIEW_DETAILS' | translate }}</button>
            </div>
          </div>
          <ng-template #noCalculatedTrips><div class="no-data-small"><p>{{ 'SALAIRES.NO_CALCULATED_TRIPS' | translate }}</p></div></ng-template>
        </div>
      </div>
    </div>
  </div>
</div>
